package net.minecraft.src;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.util.Properties;

import javax.swing.SwingUtilities;

import net.minecraft.src.forge.MinecraftForge;
import net.minecraft.src.forge.NetworkMod;
import net.minecraft.src.wifi.BlockRedstoneWireless;
import net.minecraft.src.wifi.BlockRedstoneWirelessOverride;
import net.minecraft.src.wifi.BlockRedstoneWirelessR;
import net.minecraft.src.wifi.BlockRedstoneWirelessT;
import net.minecraft.src.wifi.ConfigStoreRedstoneWireless;
import net.minecraft.src.wifi.LoggerRedstoneWireless;
import net.minecraft.src.wifi.RedstoneEther;
import net.minecraft.src.wifi.RedstoneEtherGui;
import net.minecraft.src.wifi.TileEntityRedstoneWirelessR;
import net.minecraft.src.wifi.TileEntityRedstoneWirelessT;

public class mod_WirelessRedstone extends NetworkMod {
	public static Block blockWirelessR;
	public static Block blockWirelessT;

	public static int rxID=127;
	public static int txID=126;
	
	public static int etherPackID=235;
	public static int guiPackID=236;
	
	public static int manualUpdate = 10;
	public static int stateUpdate = 100;
	public static int initUpdate = 2;
	
	public static boolean guiOn = false;
	
	public static int spriteTopOn;
	public static int spriteTopOff;
	public static int spriteROn;
	public static int spriteROff;
	public static int spriteTOn;
	public static int spriteTOff;
	
	public static NetworkMod instance;
	
	private static boolean loaded = false;
	
	public mod_WirelessRedstone() {
		instance = this;
		load();
	}

	@Override
	public void load() {
		if ( !loaded ) {
			loaded = true;
	    	MinecraftForge.registerConnectionHandler(new NetworkConnection());
			ModLoader.registerBlock(blockWirelessR);
			ModLoader.registerTileEntity(TileEntityRedstoneWirelessR.class, "Wireless Receiver");
			ModLoader.registerBlock(blockWirelessT);
			ModLoader.registerTileEntity(TileEntityRedstoneWirelessT.class, "Wireless Transmitter");
			
			if ( !java.awt.GraphicsEnvironment.isHeadless() && guiOn ) {
				RedstoneEtherGui ex = new RedstoneEtherGui();
				RedstoneEther.getInstance().assGui(ex);
				ex.setVisible(true);
			}
				
			Packet.addIdClassMapping(etherPackID, true, true, net.minecraft.src.wifi.network.PacketRedstoneEther.class);
			Packet.addIdClassMapping(guiPackID, true, true, net.minecraft.src.wifi.network.PacketOpenWindowRedstoneWireless.class);
			
			
			Thread thr = new Thread(new Runnable() {			
				@Override
				public void run() {	
					if ( mod_WirelessRedstone.manualUpdate < 1 ) return;
					
					while ( true ) {
						try {
							Thread.sleep(mod_WirelessRedstone.manualUpdate*1000);
						} catch (InterruptedException e) {
							e.printStackTrace();
						}
						PacketHandlerRedstoneWireless.PacketHandlerOutput.sendEtherTilesToAll(0);
					}
				}
			});
			thr.setName("WirelessRedstoneUpdaterThread");
			thr.start();
		}
	}
	
	@Override
	public String getVersion() {
		return "1.5";
	}

	@Override
	public String toString() {
		return "WirelessRedstone "+getVersion();
	}
	
	
/*	@Override
	public void handleLogin(EntityPlayerMP entityplayermp) {
		PacketHandlerRedstoneWireless.PacketHandlerOutput.sendEtherTilesTo(entityplayermp,initUpdate*1000);
	}
	
	
	@Override
	public void handlePacket(Packet230ModLoader packet, EntityPlayerMP player) {
		PacketHandlerRedstoneWireless.handlePacket(packet, player);
	}*/
	
	public static void AddRecipes() {
		ModLoader.addRecipe(new ItemStack(blockWirelessR, 1), new Object[] {
            "IRI", "RLR", "IRI", Character.valueOf('I'), Item.ingotIron, Character.valueOf('R'), Item.redstone, Character.valueOf('L'), Block.lever
        });
		ModLoader.addRecipe(new ItemStack(blockWirelessT, 1), new Object[] {
            "IRI", "RTR", "IRI", Character.valueOf('I'), Item.ingotIron, Character.valueOf('R'), Item.redstone, Character.valueOf('T'), Block.torchRedstoneActive
        });
	}
	
	public static void loadBlockTextures() {
		spriteTopOn = 	ModLoader.addOverride("/terrain.png", "/WirelessSprites/topOn.png");
		spriteTopOff = 	ModLoader.addOverride("/terrain.png", "/WirelessSprites/topOff.png");
		spriteROn = 	ModLoader.addOverride("/terrain.png", "/WirelessSprites/rxOn.png");
		spriteROff =	ModLoader.addOverride("/terrain.png", "/WirelessSprites/rxOff.png");
		spriteTOn =		ModLoader.addOverride("/terrain.png", "/WirelessSprites/txOn.png");
		spriteTOff =	ModLoader.addOverride("/terrain.png", "/WirelessSprites/txOff.png");
	}
	
	public static void addOverrideToReceiver(BlockRedstoneWirelessOverride override) {
		LoggerRedstoneWireless.getInstance("Wireless Redstone").write("Override added to "+blockWirelessR.getClass().toString()+": "+override.getClass().toString(), LoggerRedstoneWireless.LogLevel.DEBUG);
		((BlockRedstoneWireless)blockWirelessR).addOverride(override);
	}
	
	public static void addOverrideToTransmitter(BlockRedstoneWirelessOverride override) {
		LoggerRedstoneWireless.getInstance("Wireless Redstone").write("Override added to "+blockWirelessT.getClass().toString()+": "+override.getClass().toString(), LoggerRedstoneWireless.LogLevel.DEBUG);
		((BlockRedstoneWireless)blockWirelessT).addOverride(override);
	}
	
	private static void loadConfig() {
		rxID = (Integer) ConfigStoreRedstoneWireless.getInstance("WirelessRedstone").get("Receiver.ID", Integer.class, new Integer(rxID));
		txID = (Integer) ConfigStoreRedstoneWireless.getInstance("WirelessRedstone").get("Transmitter.ID", Integer.class, new Integer(txID));
		guiOn = (Boolean) ConfigStoreRedstoneWireless.getInstance("WirelessRedstone").get("Ether.Gui", Boolean.class, new Boolean(guiOn));
		manualUpdate = (Integer) ConfigStoreRedstoneWireless.getInstance("WirelessRedstone").get("Ether.Update.Intervall", Integer.class, new Integer(manualUpdate));
		stateUpdate = (Integer) ConfigStoreRedstoneWireless.getInstance("WirelessRedstone").get("Ether.Update.StateDelay", Integer.class, new Integer(stateUpdate));
		initUpdate = (Integer) ConfigStoreRedstoneWireless.getInstance("WirelessRedstone").get("Ether.Update.LoginDelay", Integer.class, new Integer(initUpdate));
		etherPackID = (Integer) ConfigStoreRedstoneWireless.getInstance("WirelessRedstone").get("Packet.Ether.ID", Integer.class, new Integer(etherPackID));
		guiPackID = (Integer) ConfigStoreRedstoneWireless.getInstance("WirelessRedstone").get("Packet.Gui.ID", Integer.class, new Integer(guiPackID));
	}
	
	static {
		loadConfig();
		loadBlockTextures();
		blockWirelessR = (new BlockRedstoneWirelessR(rxID)).setHardness(1.0F).setStepSound(Block.soundMetalFootstep).setBlockName("wifir");
		blockWirelessT = (new BlockRedstoneWirelessT(txID)).setHardness(1.0F).setStepSound(Block.soundMetalFootstep).setBlockName("wifit");
		AddRecipes();
	}
}
